import { rayc } from 'raycasting';

const samplesAlongX = 4;
const samplesAlongY = 8;
const samplesAlongZ = 3;

mp.events.add('render', () => {
	const target = rayc.getEntityBeingLookedAt();
	if (target == undefined) return;
	if (target.entity.handle == undefined) return;
	if (target.entity.type != 'vehicle') return;
	const vehicle = mp.vehicles.atHandle(target.entity.handle);
	const { minimum, maximum } = mp.game.gameplay.getModelDimensions(vehicle.model);

	/*
	const posMax = mp.game.entity.getOffsetFromInWorldCoords(target.entity.handle, maximum.x, maximum.y, maximum.z);
	const posMin = mp.game.entity.getOffsetFromInWorldCoords(target.entity.handle, minimum.x, minimum.y, minimum.z);
	mp.game.graphics.drawMarker(28, posMin.x, posMin.y, posMin.z, 0, 0, 0, 0, 0, 0, 0.305, 0.305, 0.305, 255, 0, 0, 64, false, false, 2, false, null, null, false);
	mp.game.graphics.drawMarker(28, posMin.x, posMin.y, posMin.z, 0, 0, 0, 0, 0, 0, 0.305, 0.305, 0.305, 255, 0, 0, 64, false, false, 2, false, null, null, false);
	*/

	const sx = (maximum.x - minimum.x) / samplesAlongX;
	const sy = (maximum.y - minimum.y) / samplesAlongY;
	const sz = (maximum.z - minimum.z) / samplesAlongZ;

	for (let ix = 0; ix < samplesAlongX; ix++) {
		for (let iy = 0; iy < samplesAlongY; iy++) {
			for (let iz = 0; iz < samplesAlongZ; iz++) {
				const { x, y, z } = mp.game.entity.getOffsetFromInWorldCoords(target.entity.handle, minimum.x + ix * sx + sx / 2, minimum.y + iy * sy + sy / 2, minimum.z + iz * sz + sz / 2);
				mp.game.graphics.drawMarker(28, x, y, z, 0, 0, 0, 0, 0, 0, 0.1, 0.1, 0.1, 255, 0, 0, 64, false, false, 2, false, null, null, false);
			}
		}
	}
});

let deformations: any[] = [
	{
		pos: {
			x: -0.7600936889648438,
			y: -2.4403681457042694,
			z: -0.03581629196802777
		},
		dmg: 1030621186
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -2.4403681457042694,
			z: 0.46757310628890986
		},
		dmg: 1029236478
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -2.4403681457042694,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.7726739943027496,
			z: -0.03581629196802777
		},
		dmg: 977671298
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.7726739943027496,
			z: 0.46757310628890986
		},
		dmg: 957136126
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.7726739943027496,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.1049798429012299,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.1049798429012299,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -1.1049798429012299,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -0.4372856914997101,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -0.4372856914997101,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: -0.4372856914997101,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.2304084599018097,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.2304084599018097,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.2304084599018097,
			z: 0.9709625045458474
		},
		dmg: 927484687
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.8981026113033295,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.8981026113033295,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 0.8981026113033295,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 1.5657967627048492,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 1.5657967627048492,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 1.5657967627048492,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 2.233490914106369,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 2.233490914106369,
			z: 0.46757310628890986
		},
		dmg: 1002374901
	},
	{
		pos: {
			x: -0.7600936889648438,
			y: 2.233490914106369,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -2.4403681457042694,
			z: -0.03581629196802777
		},
		dmg: 1023499654
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -2.4403681457042694,
			z: 0.46757310628890986
		},
		dmg: 1018957111
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -2.4403681457042694,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.7726739943027496,
			z: -0.03581629196802777
		},
		dmg: 1009851338
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.7726739943027496,
			z: 0.46757310628890986
		},
		dmg: 982413277
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.7726739943027496,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.1049798429012299,
			z: -0.03581629196802777
		},
		dmg: 984637018
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.1049798429012299,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -1.1049798429012299,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -0.4372856914997101,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -0.4372856914997101,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: -0.4372856914997101,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.2304084599018097,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.2304084599018097,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.2304084599018097,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.8981026113033295,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.8981026113033295,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 0.8981026113033295,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 1.5657967627048492,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 1.5657967627048492,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 1.5657967627048492,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 2.233490914106369,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 2.233490914106369,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: -0.2533702850341797,
			y: 2.233490914106369,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -2.4403681457042694,
			z: -0.03581629196802777
		},
		dmg: 985822619
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -2.4403681457042694,
			z: 0.46757310628890986
		},
		dmg: 994388298
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -2.4403681457042694,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.7726739943027496,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.7726739943027496,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.7726739943027496,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.1049798429012299,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.1049798429012299,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -1.1049798429012299,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -0.4372856914997101,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -0.4372856914997101,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: -0.4372856914997101,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.2304084599018097,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.2304084599018097,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.2304084599018097,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.8981026113033295,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.8981026113033295,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 0.8981026113033295,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 1.5657967627048492,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 1.5657967627048492,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 1.5657967627048492,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 2.233490914106369,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 2.233490914106369,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.2533531188964844,
			y: 2.233490914106369,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -2.4403681457042694,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -2.4403681457042694,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -2.4403681457042694,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.7726739943027496,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.7726739943027496,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.7726739943027496,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.1049798429012299,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.1049798429012299,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -1.1049798429012299,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -0.4372856914997101,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -0.4372856914997101,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: -0.4372856914997101,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.2304084599018097,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.2304084599018097,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.2304084599018097,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.8981026113033295,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.8981026113033295,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 0.8981026113033295,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 1.5657967627048492,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 1.5657967627048492,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 1.5657967627048492,
			z: 0.9709625045458474
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 2.233490914106369,
			z: -0.03581629196802777
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 2.233490914106369,
			z: 0.46757310628890986
		},
		dmg: 0
	},
	{
		pos: {
			x: 0.7600765228271484,
			y: 2.233490914106369,
			z: 0.9709625045458474
		},
		dmg: 0
	}
];
mp.events.add('vehicle:saveDeformation', () => saveVehicleDeformation());
function saveVehicleDeformation() {
	if (!mp.players.local.vehicle) return;
	deformations = [];
	const { minimum, maximum } = mp.game.gameplay.getModelDimensions(mp.players.local.vehicle.model);
	const sx = (maximum.x - minimum.x) / samplesAlongX;
	const sy = (maximum.y - minimum.y) / samplesAlongY;
	const sz = (maximum.z - minimum.z) / samplesAlongZ;

	for (let ix = 0; ix < samplesAlongX; ix++) {
		for (let iy = 0; iy < samplesAlongY; iy++) {
			for (let iz = 0; iz < samplesAlongZ; iz++) {
				deformations.push({
					pos: new mp.Vector3(minimum.x + ix * sx + sx / 2, minimum.y + iy * sy + sy / 2, minimum.z + iz * sz + sz / 2),
					dmg: mp.game.invoke(
						RageEnums.Natives.VEHICLE.GET_VEHICLE_DEFORMATION_AT_POS,
						mp.players.local.vehicle.handle,
						minimum.x + ix * sx + sx / 2,
						minimum.y + iy * sy + sy / 2,
						minimum.z + iz * sz + sz / 2
					)
				});
			}
		}
	}
	mp.gui.chat.push(deformations.length.toString());
	mp.events.callRemote('consoleLog', JSON.stringify({ deformations }));
}

mp.events.add('vehicle:applyDeformation', () => applyDeformation());
function applyDeformation() {
	if (!mp.players.local.vehicle) return;
	mp.gui.chat.push('applying deformations');
	let n = 0;
	deformations.forEach((deformartion) => {
		let { x, y, z } = deformartion.pos;
		for (let i = 0; i < 20; i++) {
			if (mp.game.invoke(RageEnums.Natives.VEHICLE.GET_VEHICLE_DEFORMATION_AT_POS, mp.players.local.vehicle.handle, x, y, z) < deformartion.dmg) {
				break;
			}
			n++;
			mp.gui.chat.push('applied 100 damage' + Date.now());
			mp.game.invoke(RageEnums.Natives.VEHICLE.SET_VEHICLE_DAMAGE, mp.players.local.vehicle.handle, x, y, z, 10000, 100, true);
		}
	});
	mp.gui.chat.push('applied a total of ' + n + ' rounds of dmg');
}
